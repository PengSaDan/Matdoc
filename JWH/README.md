### 3 / 15 (수)
- 병원 테이블을 만드는데 hive 에서 auto_increment 붙이는 법을 탐구중.. 겨우 해결했으나 아직 테이블을 완성하진 못했다. 
### 3 / 16 (목)
- 병원, 병원상세 테이블 hive에 생성 완료.
    - 약 관련 데이터 hdfs 에 적재 완료 -> 금 오전에 마무리 할 예정
- 중간발표 스크립트 작성

### 3 / 17 (금)
- 약 기본 테이블 만드는 중 hive에서 서브쿼리가 실행되지 않는 이슈로 지연중
- 중간발표 진행

# 백엔드 개발 1주차 톺아보기
- 월화 : (월)MapReduce와 (화)Hive를 공부하기 위해 블로그 글들을 보며 예제를 찾아 따라했다. 맵리듀스는 코드가 자바로 작성되지만 기본참조형이나 라이브러리가 많이 달라 코드를 쉽게 읽기 어려웠다.하이브는 SQL쿼리로 작성하기만 하면되서 맵리듀스보다 이용이 어렵진 않았다.
- 수 :  hive에서의 auto_increment 문제. 대체적으로 시도하라고 알려진 모든 코드가 돌아가지 않았다. 일단 hive를 켜서 show function; 하는것도 잘 안됐다. 인터넷을 전전하다가 jar파일이 라이브러리에 제대로 추가가 안되는게 아닐까..? 하고 hdfs에 jar를 올린 후 lib추가해줬더니 잘 돌아갔다. hive가 읽을 수 있는 곳까지 끌고와야한다고 생각했다. 이걸로 하루 마감.
- 목 : 이제 나를 막을 복병은 없다고 생각했으나 sqoop이 에러가 났다. 병원, 병원상세는 마무리하고 스쿱은 내일 알아보도록 하자.
- 금 : 다른 팀원은 스쿱 에러를 해결하기로 하고 나는 약 drug 테이블 쿼리를 짜기로 했다. 병원에서는 테이블 조인이 많이 없어서 느끼지 못했는데 하이브는 update와 delect를 지원하지 않고 서브쿼리도 제한적이다. 그래서 조인이 많은 약 테이블은 돌아가지 않았다.
    - 분할선을 만드는 이슈: drug 테이블에 들어가는 분할선은 여러 컬럼을 조합해 만들어야 하는 것이었다. markf와 markb에 "a분할선b" 이런식으로 string이 주어지는데 이걸 읽고 분할선의 유무를 알아야했고, 분할선이 있다면 어떤 모양으로 있는지 linef, lineb에서 확인해야 했다. like함수를 써서 "분할선"이라는 단어가 있으면 concat함수를 사용해 분할선을 표시해줬다. (hive에서 concat함수는 문법이 조금 달랐다.)
    - drug_secu 조인 : 하이브는 서브쿼리를 쓸 때 단일 행만 return받아야 한다. 그래서 내가 아무리 단일 행만 가지고 있어도 문법 자체가 단일행만 return하는 형식이어야 했다. 그래서 여러 방법들을 생각해봤는데 concat으로 하나로 묶는 방법과, NVL을 사용해 리턴을 하나만 받는 방법도 생각해봤다. 하지만 둘다 연산이 많은지 잘 돌아가지 않았고.. 결국 left outer join으로 묶어버렸다. 원래 하이브에서는 빅데이터라서 조인자체를 잘 하지않는다고 했는데 우리는 데이터가 작고 달리 해결법이 떠오르지 않아 일단 이 방법을 채택했다. 
---

### 3 / 20 (월)
- drug_desc 완성
- hive 1차로 여기까지 마감. drug의 병용금기가 join 부하로 돌아가지 않지만 당장 해결할 방법이 떠오르지않아 일단 처리된 데이터까지 스프링부트 개발하기로 결정했다.

### 3 / 21 (화)
- sqoop으로 리눅스 내 mysql에 데이터 옮기고 그 데이터를 dump 해서 서버에 올리는 것 까지 완료.
- 스프링부트 프로젝트 환경설정해서 개발 시작
    
### 3 / 22 (수)
- 스프링부트 DTO 구현
- searchByHospitalName과 findHospitalDesc 구현. 
    -  이름으로 검색에서 repositpory에 추가한 query가 실행되지 않는 문제 발생 point형으로 쓴 좌표와 경도위도 사이의 거리를 검색하는 함수인 st_distance_sphere가 jpa에서 읽히지 않는 것 같다.. 그래서 nativeQuery 옵션을 줬는데, 이는 JPQL을 쓰는것이 아니라 SQL을 바로 넣는것이다보니까 변수를 넣을 수 없는 문제가 생겼다. 내일 방언으로 함수를 만들어 다시 시도해 볼 예정

### 3 / 23 (목)
- searchByHospitalName 에러 원인 발견
        - 수요일의 문제를 오전내내 뜯어본 결과 nativeQuery문제가 아니라 JPA에서 point자체를 읽지 못하는게 문제다. 그리고 st_distance_sphere가 jpa에 있는데 MySql에선 지원을 안한다고 한다. 그래서 DB자체를 옮겨야 할지도 모르지만.. 일단 스프링 개발이 급해 두 문제는 내일 해결하기로 했다.. 로컬DB에서 point를 쓰지 않고 hosptial의 id값만 가져다가 findHospitalDesc 와 searchByHospitalName 구현을 완료하고 API작성도 1차적으로 마무리했다.
- 전문가미팅 : 하둡과 하이브가 실무에서 어떻게 사용되는지 질문했는데 확실히 우리가 쓰고있는 느낌은 아니었다. 데이터를 분산해서 저장해 빠르게 읽고 연산하는 것이 핵심인데 우리는 분산할만한 데이터 양이 되지도 않고.. 그저 맵리듀스를 써본다는 데 의의를 둔 것 같다. 

### 3 / 24 (금)
- 필터를 통한 병원검색 구현
    - 일단 구현에 집중해서  Set을 사용해서 거리와 진료과목이 맞는 병원들을 return했다.
    - 시간이 나면 querydsl로 바꿔보기
- point와 st_distance_sphere사용을 포기하고 경도 위도로 프론트에서 거리측정을 하기로 했다. between으로 좌표를 검사해 프론트에서 동서남북을 주면 그 안에있는 병원들을 return하기로. 그리고 거리 필터나 정렬은 프론트에서 처리하기로. 처음부터 DB를 잘 선택했으면 백에서 처리할 수 있던 문제인 것 같은데 사전조사가 부족했다. 지금은 DB를 바꿀 시간이 없어서 일단 프론트에서 진행.

# 백엔드 개발 2주차 톺아보기
point와 st_distance_sphere함수 사용을 위해 각고의 노력을 기울였지만 근본적인 DB선택의 문제로 불가능함을 알았다. 시간을 많이 투자했지만 별다른 성과가 없어서 속상했다.
---

### 3 / 27 (월)
- 운영시간 네이버 모바일 맵 크롤링
    - 병원검색필터를 완성하기 위해서는 운영시간이 필요해서 일단 필터링을 먼저 진행하기로 했다. 일요일에 크롤링 코드를 조금 짜놔서 그나마 수월했다.
    - nginx가 요청을 계속 받으면 404에러를 띄우면서 막아버린다.. 500개에 한번씩 걸리는 것 같다. 10분정도 있으면 다시 풀리긴 하는데 언젠가 완전 막혀버리진 않을까 걱정되긴 한다.

### 3 / 28 (화)
- 크롤링 계속 진행중
- querydsl을 사용한 병원 이름으로 검색 리팩토링
    - 필터를 통한 병원검색을 구현할때 querydsl을 사용하기 위해 이름+거리 검색을 먼저 시도해봤다.
    - 기존에 JPQL이 mybatis보다 확실히 편리하다고 생각하고 있었지만, 그래도 쿼리를 짜는 부분이 불가피하게 존재해서 SQL쿼리짜는 부분이 골치아팠다. 특히 필터는 다중 join이 들어가서 막막했는데 querydsl로 처리하면 간편할 것 같다.

### 3 / 29 (수)
- 개발일지를 매일 쓰려고했는데 쉽지않다. 바쁘다바빠 싸피사회
- querydls을 사용한 필터로 병원검색 구현 
    - 진료과목 18개와 야간/휴일진료 4개의 필터를 다중선택이 가능하도록 구현하는 과제. booleanexpression을 이용해 method를 만들고 조립하는 형식으로 필터를 쓰니까 정말 간편했다. 문제는 인터넷의 예제들은 거의 한 테이블에서 속성단위로 필터를 사용하던데, 나는 여러 테이블을 함께 봐야해서 조인이 불가피했다. (사실 '불가피했나'도 모르겠다. 일단 테이블을 병합해야하니 join을 떠올렸을 뿐..) 여기서 NPE가 지속적으로 발생하는데.. 아래로는 질문
        -  ```java
            public List<Hospital> useFilterHospital(double e, double w, double s, double n, int part, int sat, int sun, int holiday, int night) {
            JPAQueryFactory query = querydslConfig.jpaQueryFactory();
                    return query.select(hospital)
                    .from(hospital)
                    .innerJoin(hospitalPart).fetchJoin().on((partEq(hospital.hospital_id, part))) //진료과목이 일치하는 것
                    .innerJoin(hospitalTime).fetchJoin().on((openSat(hospital.hospital_id, sat)) //토요일진료,일요일진료, 공휴일진료 등이 일치하는 것
                    .or(openSun(hospital.hospital_id, sun)).or(openHoliday(hospital.hospital_id, holiday)).or(openNight(hospital.hospital_id, night)))
                    .where(locationBetween(e, w, s, n) //반경 5키로내 병원들 중에서 
                    ).distinct().fetch();
            } ```
        
            일치하는 값만 가져오기 위해서 innerjoin을 사용했는데요, 예를들어 <토요일에 진료하는 외과> 를 조회하기 위해 요청을 보내면
            5km 내 병원 : A,B,C,D
            외과: A,B 
            토요일에 진료하는 : null -> null값을 innerjoin 못함! NPE
            이런 경우가 생겨서 NPE가 발생합니다. 
            responseDTO를 사용했기 때문에 return에 문제가 없긴 하지만, 다른 좋은 해결방법이 있는지 궁금합니다. 검색해보니까 조건이 null이라도 조인을 사용하는 방법으로 full outer join을 제안하는 글을 많이 봤는데 이는 저희 구현와 맞지 않는 것 같습니다..  
        아직 해답을 찾지 못했고 일단 프론트에 API를 완성해서 넘겨주는것이 급해 이렇게 마무리하고 넘어갔다. 저렇게 쿼리를 한번에 작성하는것이 아니라 쿼리하나하나의 결과를 합치는 방법도 있는것 같은데, 시간이 나면 리팩토링 해볼 예정이다.
- 크롤링 계속진행중..
### 3 / 30 (목)
- 필터로 병원검색 구현 완료. 상기 이슈는 해결하지 못함. 진료과목 필터가 없을때, 휴일진료필터가 없을때, 둘다없을때, 둘다있을때를 if문으로 구분해 나누어서 처리하는 방법으로 임시방편. 어쨌든 구현 완료
- 병원파트를 모두 끝내고 보니 아직 유저쪽이 마무리되지않아서 병원즐겨찾기를 추가로 맡았다.
- 크롤링은 계속..

### 3 / 31 (금)
- 병원 즐겨찾기 구현 완료. 병원즐겨찾기 여부, 내가 즐겨찾기한 병원 리스트, 병원즐겨찾기 등록 및 삭제
- 병원&병원즐겨찾기 API 작성 완료.

# 백엔드 개발 3주차 톺아보기
- 일단 맡은 파트는 끝이 나서 후련하다. 스프링 개발분량이 많지는 않았는데 하이브쪽에서 시간을 많이 써서 조금 급해졌던것 같다. 하이브도 좀 맛보고 querydsl도 새로 공부해서 재밌는 개발이었다. 다음주에 문서정리와 발표준비를 하면서 여유가 있으면 이슈들도 해결하고 코드 리팩토링도 더 해볼 예정이다.