# 리팩토링

## 병원

### 병원검색

<details>
<summary>기존의 방법</summary>
<div markdown="1">

![병원검색old](/DOCS/images/capture/old/병원%20검색.png)

기존

</div>
</details>

<img src="images/capture/new/병원 검색.png" width="60%"></img>

## 약

### 의약품 검색

<details>
<summary>기존의 방법</summary>
<div markdown="1">

<img src="images/capture/old/의약품 검색.png" />

</div>
</details>

<br>

새로운 방법

<img src="images/capture/new/의약품 검색.png"  width="60%" />

기존에 if문을 통해서 검색 조건을 구현하였습니다. if문으로 구현할 경우 조건이 많아지면 if문도 많아져 코드가 길어지는 단점이 있습니다. Querydsl을 이용하여 동적으로 쿼리를 작성하고 조건을 메서드로 만들어 유연한 설계가 가능했습니다.

```java
public List<Drug> searchDrug(DrugFilterReq d) {
    JPAQueryFactory query = querydslConfig.jpaQueryFactory();
    return query.select(drug)
        .from(drug)
        .where(filteringDrug(d), filteringColor(d))
        .fetch();
}
```

의약품 검색 조건으로는 이름, 색상, 모양, 분할선, 식별 문자가 있었습니다. 색상은 여러개를 선택하여 or로 처리해야 했고, 다른 조건들은 하나씩 선택하여 and로 처리하기 위해 다른 조건들과 색상의 조건을 나눠 where절에 넣었습니다.

```java
private BooleanBuilder filteringDrug(DrugFilterReq d) {
    BooleanBuilder builder = new BooleanBuilder();

    builder
        .and(nameSearch(d.getName()))
        .and(typeSearch(d.getType()))
        .and(lineSearch(d.getLine()))
        .and(markSearch(d.getMark()));

    return builder;
}

private BooleanBuilder filteringColor(DrugFilterReq d) {
    BooleanBuilder builder = new BooleanBuilder();

    String[] colors = d.getColors().split(",");
    for (String color : colors) {
        builder.or(colorSearch(color));
    }

    return builder;
}
```

각각의 조건들은 BooleanExpression으로 구현하였습니다. 조건의 입력을 String으로 받아 StringUtils클래스의 hasText메서드를 이용하여 값이 없을 경우 null을 반환하도록 구현했습니다.

```java
/**
 * 이름 검색
 */
private BooleanExpression nameSearch(String name) {
    return StringUtils.hasText(name) ? drug.drug_name.contains(name) : null;
}
```

<br>

### 의약품 상세정보 출력

<details>
<summary>기존의 방법</summary>
<div markdown="1">

<img src="images/capture/old/의약품 상세정보 출력.png" />

</div>
</details>

### 나의 약봉지 추가

<details>
<summary>기존의 방법</summary>
<div markdown="1">

<img src="images/capture/old/나의 약봉지 추가.png" />

</div>
</details>

### 나의 약봉지 조회

<details>
<summary>기존의 방법</summary>
<div markdown="1">

<img src="images/capture/old/나의 약봉지 조회.png" />

</div>
</details>

### 나의 약봉지 삭제

<details>
<summary>기존의 방법</summary>
<div markdown="1">

<img src="images/capture/old/나의 약봉지 삭제.png" />

</div>
</details>
